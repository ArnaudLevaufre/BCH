\pagestyle{empty}
\makeatletter

\tikzset{add font/.code={\expandafter\def\expandafter\tikz@textfont\expandafter{\tikz@textfont#1}}}
\tikzset{port labels/.style={font=\sffamily\scriptsize}}

%
% Default style for components
%

\tikzset{every srr node/.style={draw,minimum width=2cm,minimum height=2cm,inner sep=1mm,outer sep=0pt,cap=round,add font=\sffamily}}
\tikzset{every dff node/.style={draw,minimum width=1cm,minimum height=1.5cm,inner sep=1mm,outer sep=0pt,cap=round,add font=\sffamily}}


%
% Shift right register
%

\pgfdeclareshape{srr}{
    % The 'minimum width' and 'minimum height' keys, not the content, determine
    % the size
    \savedanchor\northeast{%
        \pgfmathsetlength\pgf@x{\pgfshapeminwidth}%
        \pgfmathsetlength\pgf@y{\pgfshapeminheight}%
        \pgf@x=0.5\pgf@x
        \pgf@y=0.5\pgf@y
    }
    % This is redundant, but makes some things easier:
    \savedanchor\southwest{%
        \pgfmathsetlength\pgf@x{\pgfshapeminwidth}%
        \pgfmathsetlength\pgf@y{\pgfshapeminheight}%
        \pgf@x=-0.5\pgf@x
        \pgf@y=-0.5\pgf@y
    }
    % Inherit from rectangle
    \inheritanchorborder[from=rectangle]

    % Define same anchor a normal rectangle has
    \anchor{center}{\pgfpointorigin}
    \anchor{north}{\northeast \pgf@x=0pt}
    \anchor{east}{\northeast \pgf@y=0pt}
    \anchor{south}{\southwest \pgf@x=0pt}
    \anchor{west}{\southwest \pgf@y=0pt}
    \anchor{north east}{\northeast}
    \anchor{north west}{\northeast \pgf@x=-\pgf@x}
    \anchor{south west}{\southwest}
    \anchor{south east}{\southwest \pgf@x=-\pgf@x}
    \anchor{text}{
        \pgfpointorigin
        \advance\pgf@x by -.5\wd\pgfnodeparttextbox%
        \advance\pgf@y by -.5\ht\pgfnodeparttextbox%
        \advance\pgf@y by +.5\dp\pgfnodeparttextbox%
    }

    % Define anchors for signal ports
    \anchor{Din}{
        \pgf@process{\northeast}%
        \pgf@x=-1\pgf@x%
        \pgf@y=0.75\pgf@y%
    }
    \anchor{Ld}{
        \pgf@process{\northeast}%
        \pgf@x=-1\pgf@x%
        \pgf@y=0.375\pgf@y%
    }
    \anchor{Shift}{
        \pgf@process{\northeast}%
        \pgf@x=-1\pgf@x%
        \pgf@y=0\pgf@y%
    }
    \anchor{CLK}{
        \pgf@process{\northeast}%
        \pgf@x=-1\pgf@x%
        \pgf@y=-.75\pgf@y%
    }
    \anchor{Dout}{
        \pgf@process{\northeast}%
        \pgf@y=0\pgf@y%
    }

    % Draw the rectangle box and the port labels
    \backgroundpath{
        % Rectangle box
        \pgfpathrectanglecorners{\southwest}{\northeast}
        % Angle (>) for clock input
        \pgf@anchor@srr@CLK
        \pgf@xa=\pgf@x \pgf@ya=\pgf@y
        \pgf@xb=\pgf@x \pgf@yb=\pgf@y
        \pgf@xc=\pgf@x \pgf@yc=\pgf@y
        \pgfmathsetlength\pgf@x{1ex} % size depends on font size
        \advance\pgf@ya by \pgf@x
        \advance\pgf@xb by \pgf@x
        \advance\pgf@yc by -\pgf@x
        \pgfpathmoveto{\pgfpoint{\pgf@xa}{\pgf@ya}}
        \pgfpathlineto{\pgfpoint{\pgf@xb}{\pgf@yb}}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfclosepath

        % Draw port labels
        \begingroup
        \tikzset{port labels} % Use font from this style
        \tikz@textfont
        \tikz@textfont

        \pgf@anchor@srr@Din
        \pgftext[left,base,at={\pgfpoint{\pgf@x}{\pgf@y}},x=\pgfshapeinnerxsep]{\raisebox{-0.75ex}{Din}}

        \pgf@anchor@srr@CLK
        \pgftext[left,base,at={\pgfpoint{\pgf@x}{\pgf@y}},x=\pgfshapeinnerxsep]{\raisebox{-0.75ex}{}}

        \pgf@anchor@srr@Dout
        \pgftext[right,base,at={\pgfpoint{\pgf@x}{\pgf@y}},x=-\pgfshapeinnerxsep]{\raisebox{-0.75ex}{Dout}}

        \pgf@anchor@srr@Ld
        \pgftext[left,base,at={\pgfpoint{\pgf@x}{\pgf@y}},x=\pgfshapeinnerxsep]{\raisebox{-0.75ex}{Ld}}

        \pgf@anchor@srr@Shift
        \pgftext[left,base,at={\pgfpoint{\pgf@x}{\pgf@y}},x=\pgfshapeinnerxsep]{\raisebox{-0.75ex}{Shift}}

        \endgroup
    }
}

%
% Data Flip Flip (DFF) shape
%

\pgfdeclareshape{dff}{
  % The 'minimum width' and 'minimum height' keys, not the content, determine
  % the size
    \savedanchor\northeast{%
        \pgfmathsetlength\pgf@x{\pgfshapeminwidth}%
        \pgfmathsetlength\pgf@y{\pgfshapeminheight}%
        \pgf@x=0.5\pgf@x
        \pgf@y=0.5\pgf@y
    }
  % This is redundant, but makes some things easier:
    \savedanchor\southwest{%
        \pgfmathsetlength\pgf@x{\pgfshapeminwidth}%
        \pgfmathsetlength\pgf@y{\pgfshapeminheight}%
        \pgf@x=-0.5\pgf@x
        \pgf@y=-0.5\pgf@y
    }
    % Inherit from rectangle
    \inheritanchorborder[from=rectangle]

    % Define same anchor a normal rectangle has
    \anchor{center}{\pgfpointorigin}
    \anchor{north}{\northeast \pgf@x=0pt}
    \anchor{east}{\northeast \pgf@y=0pt}
    \anchor{south}{\southwest \pgf@x=0pt}
    \anchor{west}{\southwest \pgf@y=0pt}
    \anchor{north east}{\northeast}
    \anchor{north west}{\northeast \pgf@x=-\pgf@x}
    \anchor{south west}{\southwest}
    \anchor{south east}{\southwest \pgf@x=-\pgf@x}
    \anchor{text}{
        \pgfpointorigin
        \advance\pgf@x by -.5\wd\pgfnodeparttextbox%
        \advance\pgf@y by -.5\ht\pgfnodeparttextbox%
        \advance\pgf@y by +.5\dp\pgfnodeparttextbox%
    }

    % Define anchors for signal ports
    \anchor{D}{
        \pgf@process{\northeast}%
        \pgf@x=-1\pgf@x%
        \pgf@y=.5\pgf@y%
    }
    \anchor{CLK}{
        \pgf@process{\northeast}%
        \pgf@x=-1\pgf@x%
        \pgf@y=-.5\pgf@y%
    }
    \anchor{Q}{
        \pgf@process{\northeast}%
        \pgf@y=.5\pgf@y%
    }
    \anchor{Qn}{
        \pgf@process{\northeast}%
        \pgf@y=-.5\pgf@y%
    }

    \anchor{R}{
        \pgf@process{\northeast}%
        \pgf@x=0pt%
    }
    \anchor{S}{
        \pgf@process{\northeast}%
        \pgf@x=0pt%
        \pgf@y=-\pgf@y%
    }

    % Draw the rectangle box and the port labels
    \backgroundpath{
        % Rectangle box
        \pgfpathrectanglecorners{\southwest}{\northeast}
        % Angle (>) for clock input
        \pgf@anchor@dff@CLK
        \pgf@xa=\pgf@x \pgf@ya=\pgf@y
        \pgf@xb=\pgf@x \pgf@yb=\pgf@y
        \pgf@xc=\pgf@x \pgf@yc=\pgf@y
        \pgfmathsetlength\pgf@x{1ex} % size depends on font size
        \advance\pgf@ya by \pgf@x
        \advance\pgf@xb by \pgf@x
        \advance\pgf@yc by -\pgf@x
        \pgfpathmoveto{\pgfpoint{\pgf@xa}{\pgf@ya}}
        \pgfpathlineto{\pgfpoint{\pgf@xb}{\pgf@yb}}
        \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgfclosepath

        % Draw port labels
        \begingroup
        \tikzset{port labels} % Use font from this style
        \tikz@textfont

        \pgf@anchor@dff@D
        \pgftext[left,base,at={\pgfpoint{\pgf@x}{\pgf@y}},x=\pgfshapeinnerxsep]{\raisebox{-0.75ex}{D}}

        \pgf@anchor@dff@Q
        \pgftext[right,base,at={\pgfpoint{\pgf@x}{\pgf@y}},x=-\pgfshapeinnerxsep]{\raisebox{-.75ex}{Q}}

        \pgf@anchor@dff@Qn
        \pgftext[right,base,at={\pgfpoint{\pgf@x}{\pgf@y}},x=-\pgfshapeinnerxsep]{\raisebox{-.75ex}{$\overline{\mbox{Q}}$}}

        \pgf@anchor@dff@R
        \pgftext[top,at={\pgfpoint{\pgf@x}{\pgf@y}},y=-\pgfshapeinnerysep]{R}

        \pgf@anchor@dff@S
        \pgftext[bottom,at={\pgfpoint{\pgf@x}{\pgf@y}},y=\pgfshapeinnerysep]{S}

        \endgroup
    }
}


\makeatother
